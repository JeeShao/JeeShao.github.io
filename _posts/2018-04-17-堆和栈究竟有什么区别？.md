---
layout:     post
title:      堆和栈究竟有什么区别？
subtitle:   阅读《C++内存管理技术内幕》笔记
date:       2018-04-17
author:     JeeShao
header-img: img/堆栈.jpg
catalog: true
tags:
    - C++
---

# 堆和栈究竟有什么区别？

**主要区别有以下几点：**
1. **管理方式不同**
2. **空间大小不同**
3. **能否产生碎片**
4. **生长方向不同**
5. **分配方式不同**
6. **分配效率不同**

#### 管理方式
对于**栈**来讲，是由编译器自动管理，无需我们手动控制；对于**堆**来讲，释放工作由程序员控制，容易产生memory leak。
#### 空间大小
一般在32位系统下，**堆内存**可以达到4G的空间，从这个角度来看堆内存几乎是无限制的；但对于**栈**来讲，一般都是有一定的空间大小的，例如，在VC6下，默认栈空间大小是1M，不过这个 值我们可以自己进行修改。
#### 产生碎片
对于**堆**来讲，频繁的`new/delete`势必会造成内存空间的不连续，从而造成大量的碎片，使程序效率降低；对于**栈**来讲，则不会存在这个问题，因为栈使先进后出的队列，它们一一对应，以至于永远不会有一个内存块从栈中间弹出，在它弹出之前，在它上面的后进的栈内容已经被弹出。
#### 生长方向
对于**堆**来讲，生长方向是向上的，也就是向着内存地址增加的方向；对于**栈**来讲，它的生长方向是向下的，即向着内存地址减小的方向增长。
#### 分配方式
**堆**都是动态分配的，没有静态分配的堆；**栈**有2种方式分配：*静态分配* 和*动态分配*。静态分配是由编译器完成，比如局部变量的分配。动态分配由`alloca`函数进行分配，但是栈的动态分配和堆不同，它的动态分配由编译器进行释放，无需手工释放。
#### 分配效率
 **栈**是机器系统提供的数据结构，计算机会在底层对栈提供支持：分配专门的寄存器存放栈的地 址，压栈出栈都有专门的指令执行，这就决定了栈的效率比较高。**堆**则是C/C++函数库提供的，它的机制很复杂，例如为了分配一块内存，函数库会按照一定的算法（具体的算法可以参考数据结构/操作系统）在堆内存中搜索可用的足够大小的空间，如果没有足够大小的空间（可能碎片太多），就有可能调用系统功能去增加程序数据段的空间，这样就有机会分到足够大小的内存，然后进行返回。显然，**堆的效率比栈要低得多。**

---------
从这里我们可以看到，堆和栈相比，由于大量`new/delete`的使用，容易造成大量的内存碎片；由于没有专门的系统支持，效率很低，申请内存的代价也比较昂贵；除非申请分配大量的内存空间，尽量用栈。无论用堆还是栈，都要防止越界现象的发生，因为越界的后果要么是程序崩溃，要么就是摧毁堆栈结构，产生意想不到的结果。